<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Data Clean</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#2563eb', secondary: '#10b981' }, fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] } } } }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .precision-grid { background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .pulse-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen bg-slate-50 precision-grid">
    <nav class="sticky top-0 z-50 glass-effect border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary rounded-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <span class="text-lg font-extrabold">Data <span class="text-primary">Clean</span></span>
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">ADMIN</span>
            </div>
            <button onclick="logout()" class="text-sm font-semibold text-red-600">D√©connexion</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-12">
        <div class="grid grid-cols-4 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6 border">
                <p class="text-sm text-slate-600 mb-2">üë• Clients</p>
                <p class="text-3xl font-extrabold" id="totalClients">0</p>
            </div>
            <div class="glass-effect rounded-xl p-6 border border-amber-200 bg-amber-50">
                <p class="text-sm text-amber-800 mb-2">üì• Fichiers</p>
                <p class="text-3xl font-extrabold text-amber-900" id="filesReceived">0</p>
            </div>
            <div class="glass-effect rounded-xl p-6 border border-red-200 bg-red-50">
                <p class="text-sm text-red-800 mb-2">‚è≥ Mois en attente</p>
                <p class="text-3xl font-extrabold text-red-900" id="pendingMonths">0</p>
            </div>
            <div class="glass-effect rounded-xl p-6 border border-green-200 bg-green-50">
                <p class="text-sm text-green-800 mb-2">‚úÖ Publi√©s</p>
                <p class="text-3xl font-extrabold text-green-900" id="publishedDashboards">0</p>
            </div>
        </div>

        <div class="glass-effect rounded-2xl p-8 border">
            <h2 class="text-2xl font-bold mb-6">üìã Liste des clients</h2>
            <div id="clientsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="clientModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-effect rounded-2xl p-8 max-w-5xl w-full my-8 border">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-3xl font-bold" id="modalClientName"></h3>
                    <p class="text-slate-600" id="modalClientEmail"></p>
                    <div id="modalSubscriptionBadge" class="mt-2"></div>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">√ó</button>
            </div>

            <!-- FILES BY MONTH -->
            <div class="mb-8">
                <h4 class="text-xl font-bold mb-4">üìÖ Fichiers par mois</h4>
                <div id="modalFilesByMonth"></div>
            </div>
        </div>
    </div>

    <!-- MONTH DETAILS MODAL -->
    <div id="monthModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 max-w-3xl w-full border">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-2xl font-bold" id="monthModalTitle"></h3>
                <button onclick="closeMonthModal()" class="text-slate-400 hover:text-slate-600 text-2xl">√ó</button>
            </div>
            
            <div id="monthFilesList" class="space-y-3 mb-6"></div>

            <div class="border-t pt-6">
                <h4 class="text-lg font-bold mb-4">üì§ Publier le dashboard pour ce mois</h4>
                <input type="file" id="monthDashboardFile" accept=".pdf" class="hidden">
                <div onclick="document.getElementById('monthDashboardFile').click()" class="border-3 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-primary transition-all">
                    <svg class="w-12 h-12 text-slate-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="font-semibold text-slate-700">Cliquez pour choisir le PDF</p>
                </div>
                <div id="monthUploadProgress" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://xkrjtaqphzuwjwnsibzf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrcmp0YXFwaHp1d2p3bnNpYnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTYwOTgsImV4cCI6MjA4MzE5MjA5OH0.n7crc4kNbMrR4kHp-66XVlhufS4-2qp329cqvTt8hR8';
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentClient = null;
        let currentMonth = null;

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) window.location.href = 'login.html';

        const { data: userData } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (userData?.role !== 'admin') window.location.href = 'dashboard.html';

        async function loadStats() {
            const { count: clients } = await supabase.from('users').select('*', { count: 'exact', head: true }).eq('role', 'client');
            const { count: files } = await supabase.from('files').select('*', { count: 'exact', head: true });
            
            // Compter les mois en attente (mois avec fichiers mais sans dashboard)
            const { data: filesData } = await supabase.from('files').select('month, dashboard_id');
            const monthsWithFiles = new Set(filesData?.filter(f => f.month && !f.dashboard_id).map(f => f.month));
            
            const { count: published } = await supabase.from('dashboards').select('*', { count: 'exact', head: true }).eq('status', 'published');

            document.getElementById('totalClients').textContent = clients || 0;
            document.getElementById('filesReceived').textContent = files || 0;
            document.getElementById('pendingMonths').textContent = monthsWithFiles.size;
            document.getElementById('publishedDashboards').textContent = published || 0;
        }

        async function loadClients() {
            try {
                const { data: clients, error: clientsError } = await supabase.from('users').select('*').eq('role', 'client').order('created_at', { ascending: false });
                if (clientsError) throw clientsError;

                const clientsWithData = await Promise.all(clients.map(async (client) => {
                    const { data: files } = await supabase.from('files').select('*').eq('user_id', client.id);
                    const { data: subs } = await supabase.from('subscriptions').select('*').eq('user_id', client.id).order('month', { ascending: false }).limit(1);
                    
                    const filesByMonth = files?.reduce((acc, f) => {
                        if (f.month) {
                            if (!acc[f.month]) acc[f.month] = [];
                            acc[f.month].push(f);
                        }
                        return acc;
                    }, {}) || {};

                    const monthsWithoutDashboard = Object.keys(filesByMonth).filter(month => 
                        filesByMonth[month].some(f => !f.dashboard_id)
                    );

                    return { 
                        ...client, 
                        files: files || [],
                        filesByMonth,
                        latestSub: subs?.[0],
                        pendingMonths: monthsWithoutDashboard.length
                    };
                }));

                const container = document.getElementById('clientsGrid');
                if (!clientsWithData?.length) {
                    container.innerHTML = '<div class="col-span-full text-center py-12 text-slate-500">Aucun client</div>';
                    return;
                }

                container.innerHTML = clientsWithData.map(client => {
                    const hasPendingMonths = client.pendingMonths > 0;
                    let subBadge = '';
                    
                    if (client.latestSub?.status === 'free') {
                        subBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">üÜì Gratuit</span>';
                    } else if (client.latestSub?.status === 'paid') {
                        subBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">üí≥ Pay√©</span>';
                    } else {
                        subBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">‚ö†Ô∏è Impay√©</span>';
                    }

                    return `
                        <div onclick='openClientModal(${JSON.stringify(client).replace(/'/g, "&apos;")})' 
                             class="relative p-6 bg-white rounded-xl border-2 ${hasPendingMonths ? 'border-red-300 bg-red-50' : 'border-slate-200'} 
                                    cursor-pointer hover:shadow-xl transition-all hover:-translate-y-1">
                            
                            ${hasPendingMonths ? `
                                <div class="absolute -top-2 -right-2 px-3 py-1 bg-red-500 text-white rounded-full text-xs font-bold pulse-badge">
                                    ${client.pendingMonths} mois
                                </div>
                            ` : ''}

                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-xl font-bold text-slate-900">${client.laverie_name}</h3>
                                    ${subBadge}
                                </div>
                                <p class="text-sm text-slate-500">${client.email}</p>
                            </div>

                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Fichiers envoy√©s :</span>
                                    <span class="font-bold">${client.files.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Mois en attente :</span>
                                    <span class="font-bold ${hasPendingMonths ? 'text-red-600' : 'text-green-600'}">
                                        ${client.pendingMonths}
                                    </span>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t">
                                <button class="w-full py-2 bg-primary text-white rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
                                    Voir les d√©tails ‚Üí
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        window.openClientModal = function(client) {
            currentClient = client;
            document.getElementById('modalClientName').textContent = client.laverie_name;
            document.getElementById('modalClientEmail').textContent = client.email;

            let subBadge = '';
            if (client.latestSub?.status === 'free') {
                subBadge = '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold">üÜì Premier mois gratuit</span>';
            } else if (client.latestSub?.status === 'paid') {
                subBadge = `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-bold">üí≥ Pay√© - ${formatMonth(client.latestSub.month)}</span>`;
            } else {
                subBadge = '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-bold">‚ö†Ô∏è Abonnement impay√©</span>';
            }
            document.getElementById('modalSubscriptionBadge').innerHTML = subBadge;

            const filesByMonth = document.getElementById('modalFilesByMonth');
            
            if (Object.keys(client.filesByMonth).length === 0) {
                filesByMonth.innerHTML = '<p class="text-center text-slate-500 py-8">Aucun fichier</p>';
            } else {
                filesByMonth.innerHTML = Object.entries(client.filesByMonth)
                    .sort(([a], [b]) => b.localeCompare(a))
                    .map(([month, files]) => {
                        const hasDashboard = files.every(f => f.dashboard_id);
                        return `
                            <div onclick='openMonthModal("${month}", ${JSON.stringify(files).replace(/'/g, "&apos;")})' 
                                 class="p-4 bg-slate-50 rounded-lg border-2 ${hasDashboard ? 'border-green-200 bg-green-50' : 'border-amber-300 bg-amber-50'} cursor-pointer hover:shadow-lg transition-all">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold text-lg">üìÖ ${formatMonth(month)}</p>
                                        <p class="text-sm text-slate-600">${files.length} fichier${files.length > 1 ? 's' : ''}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${hasDashboard ? 'bg-green-200 text-green-900' : 'bg-amber-200 text-amber-900'}">
                                        ${hasDashboard ? '‚úÖ Dashboard cr√©√©' : '‚è≥ En attente'}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            document.getElementById('clientModal').classList.remove('hidden');
        }

        window.openMonthModal = function(month, files) {
            event.stopPropagation();
            currentMonth = month;
            document.getElementById('monthModalTitle').textContent = `üìÖ ${formatMonth(month)}`;
            
            const filesList = document.getElementById('monthFilesList');
            filesList.innerHTML = files.map(file => `
                <div class="p-4 bg-slate-50 rounded-lg border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-semibold">${file.original_name}</p>
                            <p class="text-sm text-slate-600 mt-1">${file.description}</p>
                            <p class="text-xs text-slate-400 mt-1">${new Date(file.upload_date).toLocaleString('fr-FR')}</p>
                        </div>
                        <button onclick='downloadFile("${file.file_path}", "${file.original_name}")' 
                                class="ml-4 px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-700">
                            üì• T√©l√©charger
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('monthModal').classList.remove('hidden');
        }

        window.downloadFile = async function(path, filename) {
            event.stopPropagation();
            try {
                const { data } = await supabase.storage.from('client-uploads').download(path);
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        document.getElementById('monthDashboardFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentClient || !currentMonth) return;

            const progress = document.getElementById('monthUploadProgress');
            progress.className = 'p-4 bg-blue-100 text-blue-800 rounded-lg';
            progress.textContent = 'üì§ Upload...';

            try {
                const cleanFileName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-zA-Z0-9._-]/g, '_').replace(/\s+/g, '_');
                const fileName = `${currentClient.id}/${Date.now()}_${cleanFileName}`;
                const { data: uploadData, error: uploadError } = await supabase.storage.from('dashboards').upload(fileName, file);
                if (uploadError) throw uploadError;

                const { data: dashData, error: dashError } = await supabase.from('dashboards').insert({ 
                    user_id: currentClient.id,
                    period: formatMonth(currentMonth),
                    status: 'published',
                    dashboard_path: uploadData.path,
                    published_at: new Date().toISOString()
                }).select().single();
                if (dashError) throw dashError;

                // Marquer tous les fichiers du mois comme trait√©s
                await supabase.from('files').update({ dashboard_id: dashData.id }).eq('user_id', currentClient.id).eq('month', currentMonth);

                progress.className = 'p-4 bg-green-100 text-green-800 rounded-lg';
                progress.textContent = '‚úÖ Dashboard publi√© !';

                setTimeout(() => { closeMonthModal(); closeModal(); loadStats(); loadClients(); }, 1500);

            } catch (error) {
                progress.className = 'p-4 bg-red-100 text-red-800 rounded-lg';
                progress.textContent = '‚ùå ' + error.message;
            }
        });

        function formatMonth(monthStr) {
            const [year, month] = monthStr.split('-');
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            return `${months[parseInt(month) - 1]} ${year}`;
        }

        window.closeModal = function() {
            document.getElementById('clientModal').classList.add('hidden');
            currentClient = null;
        }

        window.closeMonthModal = function() {
            document.getElementById('monthModal').classList.add('hidden');
            document.getElementById('monthDashboardFile').value = '';
            document.getElementById('monthUploadProgress').innerHTML = '';
            currentMonth = null;
        }

        window.logout = async function() { await supabase.auth.signOut(); window.location.href = 'index.html'; }

        loadStats();
        loadClients();
        setInterval(() => { loadStats(); loadClients(); }, 30000);
    </script>
</body>
</html>
